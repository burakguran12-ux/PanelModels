<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PanelModels — Galeri Görüntüleyici</title>
<link rel="icon" href="favicon.ico?v=5" sizes="any">
<!-- head içine -->
<script type="module" src="./x-3d-configurator.js"></script>
<style>
:root{
  --bg:#0b0f14; --panel:#111821; --text:#eaf0f8; --muted:#a3aebb; --border:#1e2a39;
  --accent:#68c3ff; --hover-accent:#698C8C;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

/* Layout */
.app{display:grid;grid-template-columns:320px 1fr;grid-template-rows:auto 1fr;gap:12px;height:100%}
header{grid-column:1/-1;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
header h1{margin:0;font-size:18px}
header small{color:var(--muted)}
.btn{background:#0e141c;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px;cursor:pointer;transition:color .15s,border-color .15s}
.btn:hover{border-color:#2c3e55}
.only-mobile{display:none}

aside.side{padding:12px;background:var(--panel);border-right:1px solid var(--border);overflow:auto}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.card{background:#0e141c;border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column}
.card:hover{outline:1px solid #29415a}
.card img{width:100%;aspect-ratio:4/3;object-fit:cover;background:#000}
.card .meta{padding:6px 8px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px}

/* Viewer */
.viewer{position:relative;background:#000;border-radius:12px;overflow:visible;margin:0 12px 12px 0}
model-viewer{width:100%;height:100%;min-height:560px;--poster-color:transparent}

/* Sağ panel */
.controls{position:absolute; top:12px; right:12px; z-index:20; display:flex; flex-direction:column; gap:10px; width:min(340px,32vw)}
.card2{background:rgba(10,14,20,.50); backdrop-filter:blur(4px); border:1px solid var(--border); border-radius:12px; padding:10px;}
.card2 h3{margin:0 0 8px 0; font-size:12px; color:var(--muted); letter-spacing:.3px; text-transform:uppercase}
.row{display:flex; align-items:center; gap:8px}
.row label{font-size:12px; color:var(--muted); width:92px}
input[type="range"]{width:100%; accent-color:var(--accent)}
.presetbar{display:flex; gap:6px; margin:8px 0 4px}
.presetbar .btn{padding:6px 8px; font-size:12px}

/* Kamera kartı: dikey + kare ikonlar + zoom/FOV */
.card2.cam{width:33%; align-self:flex-end}
.iconbar{display:flex; flex-direction:column; gap:8px}
.iconbtn{
  width:100%; aspect-ratio:1/1; display:grid; place-items:center;
  border:1px solid var(--border); background:#0e141c; border-radius:10px;
  cursor:pointer; color:#fff; transition:border-color .15s, color .12s, background .15s
}
.iconbtn:hover{border-color:#2c3e55; color:var(--hover-accent)}
.iconbtn svg{width:26px; height:26px}
.camextras{margin-top:8px; display:flex; flex-direction:column; gap:8px}
.camextras .zoomrow{display:flex; gap:8px}
.zoom{flex:1 1 50%; padding:8px 0; text-align:center; border:1px solid var(--border); background:#0e141c; border-radius:10px; cursor:pointer; transition:border-color .15s}
.zoom:hover{border-color:#2c3e55}

/* Alt palet bar — ortalanmış tek sıra */
.pbar{
  position:absolute; left:12px; right:12px; bottom:max(22px, env(safe-area-inset-bottom));
  z-index:25; background:transparent; border:none; padding:4px 10px 16px 10px; pointer-events:auto;
}
.pbar .title{display:none}

/* Scroller sarmalı (overflow sorunu çözümü) */
.swscroll{position:relative; overflow:visible}
.xscroll{
  overflow-x:auto; overflow-y:visible; /* bazı tarayıcılarda y=visible yok sayılıyor, o yüzden yukarıdaki wrapper da visible */
  scrollbar-width:thin;
  scrollbar-gutter:stable both-edges;
  padding-bottom:18px; /* hover’da büyüyene nefes */
}
.xscroll::-webkit-scrollbar{height:8px}
.xscroll::-webkit-scrollbar-thumb{background:#253548;border-radius:8px}

/* İçerik */
.swwrap{display:flex; gap:14px; width:max-content; margin:0 auto}

/* Swatch — default 51px, hover’da 2.15x, yukarı pop */
.swmini{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:60px;position:relative;overflow:visible}
.swatch{
  width:51px;height:51px;border-radius:10px;border:1px solid var(--border);
  cursor:pointer;background-size:cover;background-position:center;
  transition:transform .18s cubic-bezier(.2,.6,.2,1), box-shadow .18s ease, outline-color .18s;
  will-change:transform; transform-origin:bottom center;
}
.swmini:hover .swatch,
.swatch:focus-visible{transform:scale(2.15) translateY(-6px); z-index:30; box-shadow:0 16px 30px rgba(0,0,0,.40); outline:1px solid var(--accent)}
.slabel{font-size:10px;color:var(--muted);max-width:64px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Reset hover rengi */
#bgReset:hover{ color:var(--hover-accent) }
#bgReset:active{ color:var(--hover-accent) }

/* Mobile tweaks (mevcut mobil düzeni koruyoruz) */
@media (max-width: 900px){
  .only-mobile{display:inline-flex}
  .app{grid-template-columns:1fr; grid-template-rows:auto 1fr}
  aside.side{position:fixed; z-index:50; top:0; left:0; bottom:0; width:min(84vw, 360px); transform:translateX(-105%); transition:transform .28s ease; border-right:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,.4)}
  aside.side.open{ transform:translateX(0) }
  model-viewer{ min-height:65vh }
  .controls{ position:static; width:auto; margin:12px; }
  .pbar{ left:8px; right:8px; bottom:8px }
}
@media (max-width: 420px){ model-viewer{ min-height:70vh } }
@supports(padding:max(0px)){
  header{ padding-left:max(12px, env(safe-area-inset-left)); padding-right:max(12px, env(safe-area-inset-right)) }
}
.hint{color:var(--muted);font-size:12px}
.spacer{flex:1 1 auto}
.overlay{position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(2px); z-index:40}
.badge{display:inline-block;padding:.2em .5em;border:1px solid var(--border);border-radius:6px;background:#0e141c;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="app">
    <header>
      <button id="menuBtn" class="btn only-mobile" aria-label="Menüyü aç/kapat">☰</button>
      <h1>PanelModels</h1>
      <small class="hint">Galeri • Malzeme paleti • Sahne & Kamera</small>
      <div class="spacer"></div>
      <button id="fsBtn" class="btn only-mobile" aria-label="Tam ekran">⤢</button>
    </header>

    <aside id="side" class="side">
      <div id="gallery" class="grid"></div>
    </aside>
    <div id="overlay" class="overlay" hidden></div>

    <main class="viewer" id="viewerHost">
      <model-viewer id="mv"
        camera-controls touch-action="pan-y"
        shadow-intensity="0.7" exposure="1" environment-rotation="0deg"
        field-of-view="45deg" min-field-of-view="20deg" max-field-of-view="85deg"
        min-camera-orbit="auto auto 60%" max-camera-orbit="auto auto 260%"
        reveal="auto" alt="3B model görüntüleyici">
      </model-viewer>

      <!-- Sağ panel -->
      <div class="controls">
        <!-- Sahne -->
        <div id="sceneCard" class="card2">
          <h3>Sahne</h3>
          <div class="presetbar">
            <button class="btn" data-preset="studio">Studio</button>
            <button class="btn" data-preset="day">Daylight</button>
            <button class="btn" data-preset="show">Showroom</button>
          </div>
          <div class="row"><label>Parlaklık</label><input id="exp" type="range" min="0.3" max="2.0" step="0.05" value="1.0"></div>
          <div class="row" style="margin-top:6px"><label>Gölge</label><input id="shadow" type="range" min="0" max="1" step="0.02" value="0.7"></div>
          <div class="row" style="margin-top:6px"><label>Güneş Açısı</label><input id="envrot" type="range" min="0" max="360" step="1" value="0"></div>
          <div class="row" style="margin-top:8px"><label>Arkaplan</label>
            <div style="display:flex;align-items:center;gap:10px">
              <input id="bgHue" type="range" min="0" max="360" step="1" value="180" title="Ton">
              <input id="bgSat" type="range" min="0" max="35" step="1" value="25" title="Doygunluk">
              <input id="bgVal" type="range" min="25" max="75" step="1" value="55" title="Parlaklık">
              <div id="bgPrev" style="width:26px;height:26px;border-radius:6px;border:1px solid var(--border)"></div>
              <button id="bgReset" class="btn">Reset</button>
            </div>
          </div>
        </div>

        <!-- Kamera -->
        <div class="card2 cam">
          <h3>Kamera</h3>
          <div class="iconbar">
            <button class="iconbtn" data-orbit="0deg 0deg auto" title="Üstten">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3.5" y="3.5" width="17" height="17" rx="2" stroke-width="1.8"/><rect x="7" y="7" width="10" height="4" rx="1" fill="currentColor"/></svg>
            </button>
            <button class="iconbtn" data-orbit="0deg 180deg auto" title="Alttan">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3.5" y="3.5" width="17" height="17" rx="2" stroke-width="1.8"/><rect x="7" y="13" width="10" height="4" rx="1" fill="currentColor"/></svg>
            </button>
            <button class="iconbtn" data-orbit="0deg 75deg auto" title="Önden">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4.5" y="4.5" width="15" height="15" rx="2" stroke-width="1.8"/><rect x="8" y="8" width="8" height="8" rx="1" fill="currentColor"/></svg>
            </button>
            <button class="iconbtn" data-orbit="180deg 75deg auto" title="Arkadan">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4.5" y="4.5" width="15" height="15" rx="2" stroke-width="1.8"/><path d="M8 8h8v8H8z" stroke-width="1.8"/></svg>
            </button>
            <button class="iconbtn" data-orbit="45deg 60deg auto" title="Ön sağ 45° yukarı">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4" y="6" width="14" height="12" rx="2" transform="skewX(-10)" stroke-width="1.6"/><line x1="12" y1="4" x2="18" y2="8" stroke-width="1.6"/></svg>
            </button>
          </div>
          <div class="camextras">
            <div class="row"><label>FOV</label><input id="fov" type="range" min="20" max="80" step="1" value="45"></div>
            <div class="zoomrow">
              <button id="zoomOut" class="zoom">Zoom −</button>
              <button id="zoomIn"  class="zoom">Zoom +</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Alt tek sıra palet (ortada hizalı) -->
      <div class="pbar">
        <div class="swscroll">
          <div id="xscroll" class="xscroll">
            <div id="swwrap" class="swwrap"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
import "@google/model-viewer";

const CATALOG_URL = 'catalog.json';        // doğru kök
const FILES_URL   = 'files.json';          // doğru kök
const PALETTE_URL = 'palette.json';        // 404’ü engelle: doğru ad + kök
const mv = document.querySelector('model-viewer');

let catalog = [], files = [], palette = [];
let currentIdx = 0;

// Küçük yardımcılar
const norm = s => (s||'').toLowerCase().replace(/\s+/g,'').normalize('NFKD');

// Model içindeki malzeme bul: sadece hedef isimler (örn mdf-panel)
function pickTargetMaterials(model, targets=["mdf-panel"]) {
  const wanted = targets.map(norm);
  const allMats = model?.materials || [];
  // 1) Tam eşleşme
  let hits = allMats.filter(m => wanted.includes(norm(m.name)));
  if (hits.length) return hits;
  // 2) İçeren eşleşme (kaplama vb. varyasyonlara tolerans)
  hits = allMats.filter(m => wanted.some(w => norm(m.name).includes(w)));
  if (hits.length) return hits;
  // 3) Yedek: PanelIc / iç vs hariç ilk malzeme(ler)
  return allMats.filter(m => !/panelic|ic|iç|mdf/i.test(m.name));
}

// Doku/renk uygula (yalnız hedef materyaller)
async function applySwatch(swatch) {
  await mv?.updateComplete;
  const targets = catalog[currentIdx]?.targetMaterials || ["mdf-panel"];
  const mats = pickTargetMaterials(mv.model, targets);
  if (!mats.length) return;

  const isTexture = !!swatch.texture;
  for (const mat of mats) {
    const pbr = mat.pbrMetallicRoughness;
    if (isTexture) {
      // Doku
      const tex = await mv.createTexture(swatch.texture, {usage: "baseColorTexture"});
      pbr.setBaseColorTexture(tex);
      // Dokusuz renkten kalan tonu sıfırla (tam doku görünsün)
      pbr.setBaseColorFactor([1,1,1,1]);
    } else {
      // Düz renk
      const color = hexToLinearRGBA(swatch.color || "#ffffff");
      pbr.setBaseColorTexture(null);
      pbr.setBaseColorFactor(color);
    }
  }
}

// sRGB hex -> Linear RGBA
function hexToLinearRGBA(hex){
  const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  const srgb = m ? [parseInt(m[1],16), parseInt(m[2],16), parseInt(m[3],16)].map(v=>v/255) : [1,1,1];
  const lin  = srgb.map(c => (c<=0.04045)?(c/12.92):Math.pow((c+0.055)/1.055,2.4));
  return [lin[0],lin[1],lin[2],1];
}

// Katalogtan model yükle + varsayılan poz/scale/rot
async function loadModel(idx){
  currentIdx = (idx+catalog.length)%catalog.length;
  const item = catalog[currentIdx];
  mv.src = item.src;
  await mv?.updateComplete;

  // Opsiyonel model-vaka ayarları
  const d = item.defaults || {};
  if (d.scale != null)   mv.scale = d.scale;
  if (d.position)        mv.setAttribute('reveal','auto'), mv.cameraTarget = `${d.position[0]}m ${d.position[1]}m ${d.position[2]}m`;
  if (d.rotationY != null) mv.turntableRotation = d.rotationY;
  if (d.cameraPreset)    applyCameraPreset(d.cameraPreset);
}

// Basit kamera preset’leri
function applyCameraPreset(name){
  const map = {
    front:  {orbit:'0deg 90deg auto'},
    back:   {orbit:'180deg 90deg auto'},
    left:   {orbit:'-90deg 90deg auto'},
    right:  {orbit:'90deg 90deg auto'},
    iso45:  {orbit:'30deg 80deg auto'}
  };
  const p = map[name||'iso45'];
  if (p) mv.cameraOrbit = p.orbit;
}

// Klavye kısayolları
window.addEventListener('keydown', (e)=>{
  if (e.key>='1' && e.key<='9'){
    const i = Number(e.key)-1;
    if (i < catalog.length) loadModel(i);
  }
  if (e.key === 'ArrowLeft')  mv.turntableRotation -= 5;
  if (e.key === 'ArrowRight') mv.turntableRotation += 5;
  if (e.key === '+') mv.zoom( 0.15);
  if (e.key === '-') mv.zoom(-0.15);
  if (e.key.toLowerCase()==='r') mv.resetTurntableRotation();
});

// ---- Başlat ----
(async ()=>{
  // Cache-busting: statik host’ta update sonrası eski dosya gelmesin
  const bust = `?v=${Date.now()}`;
  [catalog, files, palette] = await Promise.all([
    fetch(CATALOG_URL + bust).then(r=>r.json()),
    fetch(FILES_URL   + bust).then(r=>r.json()),
    fetch(PALETTE_URL + bust).then(r=>r.json()).catch(()=>[])
  ]);

  
  // Galeri kartlarını oluştur (thumb yoksa fallback)
  const gallery = document.getElementById('gallery');
  if (gallery) {
    gallery.innerHTML = '';
    catalog.forEach((it, i)=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img loading="lazy" src="${it.thumb || 'thumbs/default.png'}" alt="">
        <div class="meta">${it.name}</div>`;
      card.onclick = ()=>loadModel(i);
      gallery.appendChild(card);
    });
  }

  // Palet çubukları (tek sırada, scroll ile kayar)
  const row = document.getElementById('swrow');
  if (row && palette.length) {
    row.innerHTML = '';
    palette.forEach(sw=>{
      const el = document.createElement('span');
      el.className = 'swatch';
      if (sw.texture) el.style.backgroundImage = `url(${sw.texture})`;
      if (sw.color)   el.style.backgroundColor = sw.color;
      el.title = sw.name || '';
      el.onclick = ()=>applySwatch(sw);
      row.appendChild(el);
    });
  }

  // URL’de ?model=… varsa ona git, yoksa ilk model
  const prm = new URLSearchParams(location.search);
  const pModel = prm.get('model');
  const found = catalog.findIndex(c => c.src === pModel);
  await loadModel(found >= 0 ? found : 0);
})();
</script>

</body>
</html>
