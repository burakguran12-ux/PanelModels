<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PanelModels — Galeri Görüntüleyici</title>
  <link rel="icon" href="favicon.ico?v=1" sizes="any">
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111821; --text:#eaf0f8; --muted:#a3aebb; --border:#1e2a39; --accent:#68c3ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    .app{display:grid;grid-template-columns:320px 1fr;grid-template-rows:auto 1fr;gap:12px;height:100%}
    header{grid-column:1/-1;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    header h1{margin:0;font-size:18px}
    header small{color:var(--muted)}
    .btn{background:#0e141c;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px;cursor:pointer}
    .btn:hover{border-color:#2c3e55}

    aside.side{padding:12px;background:var(--panel);border-right:1px solid var(--border);overflow:auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
    .card{background:#0e141c;border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column}
    .card:hover{outline:1px solid #29415a}
    .card img{width:100%;aspect-ratio:4/3;object-fit:cover;background:#000}
    .card .meta{padding:6px 8px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px}

    .viewer{position:relative;background:#000;border-radius:12px;overflow:hidden;margin:0 12px 12px 0}
    model-viewer{width:100%;height:100%;min-height:560px;--poster-color:transparent}

    /* Alttaki palet */
    .palette{position:absolute;left:12px;right:12px;bottom:12px;background:rgba(10,14,20,.85);backdrop-filter:blur(4px);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;overflow:auto}
    .swatches{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .swchip{display:flex;flex-direction:column;align-items:center;gap:4px}
    .swatch{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);cursor:pointer;flex:0 0 auto;display:inline-block;background-size:cover;background-position:center}
    .swatch:hover{outline:1px solid var(--accent)}
    .slabel{font-size:10px;color:var(--muted);max-width:72px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .hint{color:var(--muted);font-size:12px}
    .spacer{flex:1 1 auto}
    .only-mobile{display:none}

    /* Sağ üst: sahne & kamera kontrol kartı */
    .controls{
      position:absolute; top:12px; right:12px; z-index:5;
      display:flex; flex-direction:column; gap:10px;
    }
    .card2{
      background:rgba(10,14,20,.85); backdrop-filter:blur(4px);
      border:1px solid var(--border); border-radius:12px; padding:10px; min-width:240px;
    }
    .card2 h3{margin:0 0 8px 0; font-size:12px; color:var(--muted); letter-spacing:.3px; text-transform:uppercase}
    .row{display:flex; align-items:center; gap:8px}
    .row label{font-size:12px; color:var(--muted); width:90px}
    input[type="range"]{width:100%; accent-color:var(--accent)}
    .iconbar{display:grid; grid-template-columns:repeat(5, 36px); gap:6px}
    .iconbtn{
      width:36px; height:36px; display:inline-grid; place-items:center; border:1px solid var(--border);
      background:#0e141c; border-radius:8px; cursor:pointer;
    }
    .iconbtn:hover{border-color:#2c3e55}
    .iconbtn svg{width:22px; height:22px; opacity:.9}

    /* BG pastel tekeri – yumuşak renkler için */
    .bgbox{display:flex;align-items:center;gap:10px; margin-top:6px}
    .wheelWrap{position:relative; width:128px; height:128px; flex:0 0 auto}
    canvas#bgWheel{width:128px;height:128px;border:1px solid var(--border);border-radius:50%}
    .bgPreview{width:28px;height:28px;border-radius:6px;border:1px solid var(--border)}

    /* Overlay (mobil menü için) */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(2px); z-index:40}

    /* Mobil uyarlamalar */
    @media (max-width: 900px){
      .only-mobile{display:inline-flex}
      .app{grid-template-columns:1fr; grid-template-rows:auto 1fr}
      aside.side{
        position:fixed; z-index:50; top:0; left:0; bottom:0;
        width:min(84vw, 360px); transform:translateX(-105%);
        transition:transform .28s ease; border-right:1px solid var(--border);
        box-shadow:0 10px 30px rgba(0,0,0,.4);
      }
      aside.side.open{ transform:translateX(0) }
      model-viewer{ min-height:65vh }
      .palette{ position:static; margin:8px 12px; overflow-x:auto }
      .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); gap:8px }
      .swatch{ width:36px; height:36px; border-radius:8px }
      .btn{ padding:10px 12px }
      .controls{ top:auto; bottom: calc(12px + 56px + 8px); right:12px; } /* paletin üstünde kalsın */
    }
    @media (max-width: 420px){ model-viewer{ min-height:70vh } }
    @supports(padding:max(0px)){
      header{ padding-left:max(12px, env(safe-area-inset-left)); padding-right:max(12px, env(safe-area-inset-right)) }
      .palette{ padding-bottom:max(10px, env(safe-area-inset-bottom)) }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <button id="menuBtn" class="btn only-mobile" aria-label="Menüyü aç/kapat">☰</button>
      <h1>PanelModels</h1>
      <small class="hint">Galeri • Malzeme paleti • Sahne & Kamera</small>
      <div class="spacer"></div>
      <button id="fsBtn" class="btn only-mobile" aria-label="Tam ekran">⤢</button>
    </header>

    <aside id="side" class="side">
      <div id="gallery" class="grid"></div>
    </aside>
    <div id="overlay" class="overlay" hidden></div>

    <main class="viewer" id="viewerHost">
      <model-viewer id="mv"
        camera-controls
        shadow-intensity="0.7"
        exposure="1.0"
        environment-rotation="0deg"
        touch-action="pan-y"
        reveal="auto"
        alt="3B model görüntüleyici">
        <div class="hint" slot="poster">Model yükleniyor…</div>
        <div class="hint" slot="progress-bar">Yükleniyor…</div>
        <button class="btn" slot="ar-button">AR ile Gör</button>
      </model-viewer>

      <!-- Sağ üst "Sahne" & "Kamera" kartları -->
      <div class="controls">
        <div class="card2">
          <h3>Sahne</h3>
          <div class="row">
            <label>Parlaklık</label>
            <input id="exp" type="range" min="0.3" max="1.8" step="0.05" value="1.0">
          </div>
          <div class="row" style="margin-top:6px">
            <label>Gölge</label>
            <input id="shadow" type="range" min="0" max="1" step="0.02" value="0.7">
          </div>
          <div class="row" style="margin-top:6px">
            <label>Güneş Açısı</label>
            <input id="envrot" type="range" min="0" max="360" step="1" value="0">
          </div>

          <!-- Pastel BG renk tekeri -->
          <div class="bgbox">
            <div class="wheelWrap">
              <canvas id="bgWheel" width="256" height="256"></canvas>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px">
              <div class="hint">Matlık (parlaklık)</div>
              <input id="bgV" type="range" min="25" max="75" value="55">
              <div style="display:flex;align-items:center;gap:8px">
                <div id="bgPrev" class="bgPreview"></div>
                <button id="bgReset" class="btn">Varsayılan</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card2">
          <h3>Kamera Açıları</h3>
          <div class="iconbar">
            <!-- Üstten -->
            <button class="iconbtn" data-orbit="0deg 0deg auto" title="Üstten">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="4" y="4" width="16" height="16" rx="2" stroke-width="1.6"/>
                <rect x="7" y="7" width="10" height="4" rx="1" fill="currentColor"/>
              </svg>
            </button>
            <!-- Alttan -->
            <button class="iconbtn" data-orbit="0deg 180deg auto" title="Alttan">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="4" y="4" width="16" height="16" rx="2" stroke-width="1.6"/>
                <rect x="7" y="13" width="10" height="4" rx="1" fill="currentColor"/>
              </svg>
            </button>
            <!-- Önden -->
            <button class="iconbtn" data-orbit="0deg 75deg auto" title="Önden">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="5" y="5" width="14" height="14" rx="2" stroke-width="1.6"/>
                <rect x="8" y="8" width="8" height="8" rx="1" fill="currentColor"/>
              </svg>
            </button>
            <!-- Arkadan -->
            <button class="iconbtn" data-orbit="180deg 75deg auto" title="Arkadan">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="5" y="5" width="14" height="14" rx="2" stroke-width="1.6"/>
                <path d="M8 8h8v8H8z" stroke-width="1.6"/>
              </svg>
            </button>
            <!-- Ön-sağ 45° yukarı -->
            <button class="iconbtn" data-orbit="45deg 60deg auto" title="Ön sağ 45° yukarı">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="4" y="6" width="14" height="12" rx="2" transform="skewX(-10)" stroke-width="1.6"/>
                <line x1="12" y1="4" x2="18" y2="8" stroke-width="1.6"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Altta palet -->
      <div class="palette">
        <span class="hint">Kaplama / Renk:</span>
        <div id="swatches" class="swatches"></div>
      </div>
    </main>
  </div>

<script>
(async function(){
  const mv = document.getElementById('mv');
  const gallery = document.getElementById('gallery');
  const swatches = document.getElementById('swatches');
  const host = document.getElementById('viewerHost');

  /* ---------- KATALOG / PALET ---------- */
  let catalog = null;
  try {
    const r = await fetch('catalog.json', {cache:'no-store'});
    if(r.ok){ catalog = await r.json(); }
  } catch {}
  if(!catalog){
    try {
      const r = await fetch('files.json', {cache:'no-store'});
      if(r.ok){
        const arr = await r.json();
        catalog = arr.map(name => ({ name, src:name, thumb:'thumbs/default.png' }));
      }
    } catch {}
  }
  if(!Array.isArray(catalog) || catalog.length===0){
    gallery.innerHTML = '<div class="hint">Henüz katalog yok. catalog.json veya files.json ekleyin.</div>';
    return;
  }

  let palette = null;
  try {
    const r = await fetch('materials/palette.json', {cache:'no-store'});
    if(r.ok){ palette = await r.json(); }
  } catch {}
  if(!Array.isArray(palette)){
    palette = [
      {"name":"Antrasit","#":"#2F343A"},
      {"name":"Teak Doku","texture":"materials/teak.png"},
      {"name":"Beyaz","#":"#ECEFF1"},
      {"name":"Siyah","#":"#121212"}
    ];
  }

  /* ---------- GALERİ ---------- */
  function renderGallery(items){
    gallery.innerHTML = '';
    items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = '<img loading="lazy" src="'+(item.thumb||'thumbs/default.png')+'" alt="">'
                      +'<div class="meta"><span>'+(item.title||item.name||item.src)+'</span>'
                      +'<span>'+ (item.size||'') +'</span></div>';
      card.addEventListener('click', ()=> loadModel(item));
      gallery.appendChild(card);
    });
  }
  renderGallery(catalog);

  function loadModel(item){
    mv.src = item.src;
    mv.alt = item.title || item.name || item.src;
    mv.dataset.target = (item.targetMaterials || []).join(','); // sadece hedef malzemeler
    document.title = 'PanelModels — ' + mv.alt;
  }

  /* ---------- MALZEME HEDEFİ ---------- */
  function getTargetMaterials(){
    const names = (mv.dataset.target || '')
      .split(',').map(s=>s.trim()).filter(Boolean);
    const all = mv.model?.materials || [];
    if (names.length === 0) return all; // katalog hedef vermezse hepsi (bilinçli)
    const picked = all.filter(m =>
      names.some(n => m.name === n || m.name.startsWith(n + '.')) // PanelKaplama.001 yakala
    );
    if (!picked.length) console.warn('Hedef malzeme bulunamadı:', all.map(m=>m.name));
    return picked;
  }

  function hexToRgba(hex){
    const s = hex.replace('#','');
    const h = s.length===3 ? s.split('').map(c=>c+c).join('') : s;
    const v = parseInt(h, 16);
    return [(v>>16&255)/255, (v>>8&255)/255, (v&255)/255, 1];
  }

  async function applyColor(hex){
    if(!mv.model) return;
    const mats = getTargetMaterials();
    const rgba = hexToRgba(hex);
    for (const mat of mats) {
      try {
        const pmr = mat.pbrMetallicRoughness;
        if (mat.setBaseColorTexture) mat.setBaseColorTexture(null); // doku varsa temizle
        else if (pmr?.baseColorTexture) pmr.baseColorTexture.setTexture(null);
        if (pmr?.setBaseColorFactor) pmr.setBaseColorFactor(rgba);
        else pmr.baseColorFactor = rgba;
      } catch (e) { console.warn('applyColor:', e); }
    }
    flashInfo('Renk uygulandı');
  }

  async function applyTexture(url){
    if(!mv.model) return;
    const tex = await mv.createTexture(url);
    const mats = getTargetMaterials();
    for (const mat of mats) {
      try {
        const pmr = mat.pbrMetallicRoughness;
        if (pmr?.setBaseColorFactor) pmr.setBaseColorFactor([1,1,1,1]); // tint sıfırla
        else pmr.baseColorFactor = [1,1,1,1];
        if (mat.setBaseColorTexture) { mat.setBaseColorTexture(tex); }
        else if (pmr?.setBaseColorTexture) { pmr.setBaseColorTexture(tex); }
        else if (pmr?.baseColorTexture) { pmr.baseColorTexture.setTexture(tex); }
      } catch (e) { console.warn('applyTexture:', e); }
    }
    flashInfo('Doku uygulandı');
  }

  function renderPalette(items){
    swatches.innerHTML = '';
    items.forEach(it => {
      const wrap = document.createElement('div');
      wrap.className = 'swchip';

      const el = document.createElement('span');
      el.className = 'swatch';
      if(it['#']) el.style.background = it['#'];
      if(it.texture) el.style.backgroundImage = 'url('+it.texture+')';
      el.title = it.name || '';
      el.addEventListener('click', ()=> it.texture ? applyTexture(it.texture) : applyColor(it['#']));

      const lbl = document.createElement('div');
      lbl.className = 'slabel';
      lbl.textContent = it.name || '';

      wrap.appendChild(el);
      wr
