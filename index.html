<!doctype html>
<html lang="tr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PanelModels — Galeri Görüntüleyici</title>
  <link rel="icon" href="favicon.ico?v=5" sizes="any" />

  <!-- Google Model Viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- Minimal tema -->
  <link rel="stylesheet" href="css/viewer-makeup.css" />

  <style>
    :root {
      --accent: #68c3ff;
      --hover-accent: #698C8C;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
  </style>
</head>

<body>
  <div id="app" class="pm-app">
    <!-- ÜST BAR -->
    <header class="pm-top">
      <button id="menuBtn" class="btn only-mobile" aria-label="Menüyü aç/kapat">☰</button>
      <h1>PanelModels</h1>
      <small class="hint">Galeri • Malzeme paleti • Sahne & Kamera</small>
      <div class="spacer"></div>
      <button id="fsBtn" class="btn only-mobile" aria-label="Tam ekran">⤢</button>
    </header>

    <!-- SOL KATALOG -->
    <aside id="sidebar" class="pm-left">
      <div class="pm-section-title">Modeller</div>
      <div class="pm-card-grid" id="cardGrid"><!-- kartlar JS ile çizilir --></div>
    </aside>

    <!-- ORTA GÖRÜNTÜLEYİCİ -->
    <main id="stage" class="pm-main">
      <div id="viewerHost" class="pm-canvas">
        <model-viewer id="mv" src="" camera-controls touch-action="pan-y" exposure="1.0" shadow-intensity="0.6"
          environment-image="neutral" interaction-prompt="none" poster-color="transparent"
          style="width:100%;height:100%;display:block"></model-viewer>
      </div>

      <div class="pm-overlay">
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn" id="btnShare">Paylaş</button>
      </div>
    </main>

    <!-- SAĞ KAMERA DOCK -->
    <nav id="cameras" class="pm-right">
      <div class="pm-tool" data-cam="front"><span>Ön</span></div>
      <div class="pm-tool" data-cam="iso45"><span>İzo</span></div>
      <div class="pm-tool" data-cam="zoom"><span>Zoom</span></div>
    </nav>

    <!-- ALT RENK PALETİ -->
    <footer id="palette" class="pm-palette"><!-- swatch'lar JS ile çizilir --></footer>
  </div>

  <script>
    const mv = document.getElementById('mv');
    const cardGrid = document.getElementById('cardGrid');
    const paletteHost = document.querySelector('.pm-palette');

    let catalog = [];
    let palette = [];
    let currentModel = null;

    // ---- JSON veri yükleme (palette yoksa default oluşturur)
    async function loadData() {
      const bust = `?v=${Date.now()}`;
      catalog = await fetch('catalog.json' + bust).then(r => r.json());

      try {
        palette = await fetch('palette.json' + bust).then(r => r.json());
      } catch (_) {
        // defaults — isteğe göre düzenleyebilirsin
        palette = [
          { id: '120-teak', color: '#7c6247' },
          { id: '108-gold', color: '#b29a70' },
          { id: 'white', color: '#e8e8e8' },
          { id: 'charcoal', color: '#444444' }
        ];
        console.warn('palette.json bulunamadı; default palette yüklendi.');
      }
    }

    // ---- Kartları çiz
    function renderCards() {
      if (!cardGrid) return;
      cardGrid.innerHTML = '';
      catalog.forEach((it) => {
        const id = (it.src.split('/').pop() || '').replace('.glb', '');
        const el = document.createElement('div');
        el.className = 'pm-card';
        el.dataset.model = id;
        el.innerHTML = `
          <img class="pm-thumb" src="${it.thumb || 'thumbs/default.png'}" alt="">
          <div>
            <div class="pm-card-title">${it.name || id}</div>
            <div class="pm-card-sub">GLB</div>
          </div>
          <span class="pm-chip">GLB</span>
        `;
        el.addEventListener('click', () => {
          loadModelById(id);
          document.querySelectorAll('.pm-card.is-active').forEach(c => c.classList.remove('is-active'));
          el.classList.add('is-active');
        });
        cardGrid.appendChild(el);
      });
    }

    // ---- Swatch'ları çiz
    function renderSwatches() {
      if (!paletteHost) return;
      paletteHost.querySelectorAll('.pm-swatch').forEach(n => n.remove());

      palette.forEach(sw => {
        const dot = document.createElement('div');
        dot.className = 'pm-swatch';
        dot.dataset.mat = sw.id;

        if (sw.texture) {
          dot.style.backgroundImage = `url(${sw.texture})`;
          dot.style.backgroundSize = 'cover';
          dot.style.backgroundPosition = 'center';
        } else if (sw.color) {
          dot.style.background = sw.color;
        }

        dot.addEventListener('click', () => {
          document.querySelectorAll('.pm-swatch.is-active').forEach(s => s.classList.remove('is-active'));
          dot.classList.add('is-active');
          applyMaterial(sw.id);
        });

        paletteHost.appendChild(dot);
      });
    }

    // ---- Model yükle
    async function loadModelById(id) {
      if (!mv) return;
      const item = catalog.find(c => c.src.includes(`${id}.glb`) || c.src.includes(id));
      if (!item) { console.warn('Model bulunamadı:', id); return; }

      currentModel = item;
      mv.src = item.src;
      await mv.updateComplete;

      if (item.defaults?.cameraPreset) setCameraPreset(item.defaults.cameraPreset);
      if (item.defaults?.rotationY != null) mv.turntableRotation = item.defaults.rotationY;
    }

    // ---- Materyal uygula (mutlak URL + eski/yeni API + fallback)
    async function applyMaterial(matId) {
      if (!mv) return;

      const sw = palette.find(p => p.id === matId);
      if (!sw) { console.warn('Palette yok:', matId); return; }

      await mv.updateComplete;
      const model = mv.model;
      if (!model) { console.warn('Model yok'); return; }

      const targetsLc = (currentModel?.targetMaterials || ['mdf-panel']).map(s => String(s).toLowerCase());

      let mats = model.materials.filter(m =>
        targetsLc.includes(m.name.toLowerCase()) ||
        targetsLc.some(t => m.name.toLowerCase().includes(t))
      );
      if (!mats.length) {
        console.warn('Hedef materyal bulunamadı, TÜM materyallere uygulanacak. Mevcut:', model.materials.map(m => m.name));
        mats = [...model.materials];
      }

      let tex = null;
      if (sw.texture) {
        try {
          const texUrl = new URL(sw.texture, document.baseURI).toString();
          if (typeof model.createTexture === 'function') {
            tex = await model.createTexture(texUrl);
          } else if (typeof mv.createTexture === 'function') {
            tex = await mv.createTexture(texUrl, { usage: 'baseColorTexture' });
          }
        } catch (e) {
          console.warn('Texture yüklenemedi:', sw.texture, e);
        }
      }

      const setColor = (pbr, rgba) => {
        if (typeof pbr.setBaseColorFactor === 'function') pbr.setBaseColorFactor(rgba);
        else pbr.baseColorFactor = rgba;
      };
      const setTex = (pbr, t) => {
        if (typeof pbr.setBaseColorTexture === 'function') pbr.setBaseColorTexture(t);
        else if (pbr.baseColorTexture?.setTexture) pbr.baseColorTexture.setTexture(t);
        else pbr.baseColorTexture = t ?? null;
      };
      const hexToRGBA = (hex) => {
        const h = String(hex || '#ffffff').replace('#', '');
        const r = parseInt(h.slice(0, 2), 16) / 255;
        const g = parseInt(h.slice(2, 4), 16) / 255;
        const b = parseInt(h.slice(4, 6), 16) / 255;
        return [r, g, b, 1];
      };

      for (const mat of mats) {
        const pbr = mat.pbrMetallicRoughness;
        if (!pbr) continue;

        if (tex) {
          setTex(pbr, tex);
          setColor(pbr, [1, 1, 1, 1]);
        } else if (sw.color) {
          setTex(pbr, null);
          setColor(pbr, hexToRGBA(sw.color));
        }
      }

      console.log('[material OK]', sw.id, '→', mats.map(m => m.name));
    }

    // ---- Kamera / Reset / Paylaş
    function setCameraPreset(preset) {
      if (!mv) return;

      const orbits = {
        front: '0deg 90deg auto',
        back: '180deg 90deg auto',
        left: '-90deg 90deg auto',
        right: '90deg 90deg auto',
        iso45: '30deg 80deg auto'
      };
      if (orbits[preset]) {
        mv.cameraOrbit = orbits[preset];
        mv.jumpCameraToGoal?.();
        return;
      }

      if (preset === 'zoom') {
        mv.zoom?.(0.25);
        setTimeout(() => mv.zoom?.(0.25), 120);
      }
    }

    function resetViewer() {
      if (!mv) return;
      if (currentModel?.defaults?.cameraPreset) setCameraPreset(currentModel.defaults.cameraPreset);
      else mv.cameraOrbit = '0deg 75deg auto';
      mv.fieldOfView = '45deg';
    }

    function shareCurrentView() {
      const url = new URL(location.href);
      if (currentModel) url.searchParams.set('model', currentModel.src);
      const link = url.toString();

      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(link).then(
          () => alert('Link kopyalandı:\n' + link),
          () => { prompt('Kopyalayamadım, elle kopyala:', link); }
        );
      } else {
        prompt('Kopyalamak için seç & kopyala:', link);
      }
    }

    // ---- Statik butonlar
    document.querySelectorAll('.pm-tool').forEach(btn => {
      btn.addEventListener('click', () => {
        const preset = btn.dataset.cam;
        setCameraPreset(preset);
      });
    });
    document.getElementById('btnReset')?.addEventListener('click', () => resetViewer());
    document.getElementById('btnShare')?.addEventListener('click', () => shareCurrentView());

    // ---- Boot
    (async function boot() {
      await loadData();
      renderCards();
      renderSwatches();

      const qs = new URLSearchParams(location.search);
      const direct = qs.get('model');
      if (direct) {
        const id = (direct.split('/').pop() || '').replace('.glb', '');
        await loadModelById(id);
      } else if (catalog[0]) {
        const id = (catalog[0].src.split('/').pop() || '').replace('.glb', '');
        await loadModelById(id);
        // ilk kartı işaretle
        document.querySelector(`.pm-card[data-model="${id}"]`)?.classList.add('is-active');
      }

      // ilk swatch'ı görsel olarak aktifle
      const firstSw = document.querySelector('.pm-swatch');
      if (firstSw) firstSw.classList.add('is-active');
    })();
  </script>
</body>

</html>