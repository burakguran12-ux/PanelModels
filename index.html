<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PanelModels — Galeri Görüntüleyici</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111821; --text:#eaf0f8; --muted:#a3aebb; --border:#1e2a39; --accent:#68c3ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{display:grid;grid-template-columns:320px 1fr;grid-template-rows:auto 1fr;gap:12px;height:100%}
    header{grid-column:1/-1;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    header h1{margin:0;font-size:18px}
    header small{color:var(--muted)}
    aside{padding:12px;background:var(--panel);border-right:1px solid var(--border);overflow:auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
    .card{background:#0e141c;border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column}
    .card:hover{outline:1px solid #29415a}
    .card img{width:100%;aspect-ratio:4/3;object-fit:cover;background:#000}
    .card .meta{padding:6px 8px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px}
    .viewer{position:relative;background:#000;border-radius:12px;overflow:hidden;margin:0 12px 12px 0}
    model-viewer{width:100%;height:100%;min-height:560px;--poster-color:transparent}
    .palette{position:absolute;left:12px;right:12px;bottom:12px;background:rgba(10,14,20,.85);backdrop-filter:blur(4px);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;overflow:auto}
    .swatches{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .swatch{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);cursor:pointer;flex:0 0 auto;display:inline-block}
    .swatch[title]{position:relative}
    .swatch:hover{outline:1px solid var(--accent)}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);cursor:pointer}
    .spacer{flex:1 1 auto}
    .hint{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>PanelModels</h1>
      <small class="hint">Galeri + Malzeme paleti</small>
    </header>
    <aside>
      <div id="gallery" class="grid"></div>
    </aside>
    <main class="viewer">
      <model-viewer id="mv"
        camera-controls
        shadow-intensity="0.8"
        exposure="1.0"
        ar
        ar-modes="webxr scene-viewer quick-look"
        touch-action="pan-y"
        reveal="auto"
        environment-visibility="neutral"
        alt="3B model görüntüleyici">
        <div class="hint" slot="poster">Model yükleniyor…</div>
        <div class="hint" slot="progress-bar">Yükleniyor…</div>
        <button class="chip" slot="ar-button">AR ile Gör</button>
      </model-viewer>

      <!-- Palette -->
      <div class="palette">
        <span class="hint">Kaplama / Renk:</span>
        <div id="swatches" class="swatches"></div>
        <div class="spacer"></div>
        <span id="applyInfo" class="hint"></span>
      </div>
    </main>
  </div>

<script>
(async function(){
  const mv = document.getElementById('mv');
  const gallery = document.getElementById('gallery');
  const swatches = document.getElementById('swatches');
  const applyInfo = document.getElementById('applyInfo');

  // Load catalog (prefer catalog.json, fallback to files.json)
  let catalog = null;
  try {
    const r = await fetch('catalog.json', {cache:'no-store'});
    if(r.ok){ catalog = await r.json(); }
  } catch {}
  if(!catalog){
    try {
      const r = await fetch('files.json', {cache:'no-store'});
      if(r.ok){
        const arr = await r.json();
        catalog = arr.map(name => ({ name, src:name, thumb:'thumbs/default.png' }));
      }
    } catch {}
  }
  if(!Array.isArray(catalog) || catalog.length===0){
    gallery.innerHTML = '<div class="hint">Henüz katalog yok. catalog.json veya files.json ekleyin.</div>';
    return;
  }

  // Render gallery
  function renderGallery(items){
    gallery.innerHTML = '';
    items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = '<img loading="lazy" src="'+(item.thumb||'thumbs/default.png')+'" alt="">'
                      +'<div class="meta"><span>'+(item.title||item.name||item.src)+'</span>'
                      +'<span>'+ (item.size||'') +'</span></div>';
      card.addEventListener('click', ()=> loadModel(item));
      gallery.appendChild(card);
    });
  }

  renderGallery(catalog);

  async function loadModel(item){
    mv.src = item.src;
    mv.alt = item.title || item.name || item.src;
    document.title = 'PanelModels — ' + mv.alt;
    // Optional: remember material target names
    mv.dataset.target = Array.isArray(item.targetMaterials) ? item.targetMaterials.join(',') : '';
  }

  // Palette
  let palette = null;
  try {
    const r = await fetch('materials/palette.json', {cache:'no-store'});
    if(r.ok){ palette = await r.json(); }
  } catch {}
  if(!Array.isArray(palette)){
    palette = [
      {"name":"Antrasit","#":"#2F343A"},
      {"name":"Ada Yeşili","#":"#5E7D6A"},
      {"name":"Teak Doku","texture":"materials/teak.png"},
      {"name":"Ceviz Doku","texture":"materials/walnut.png"},
      {"name":"Beyaz","#":"#ECEFF1"},
      {"name":"Siyah","#":"#121212"}
    ];
  }

  function hexToRgba(hex){
    const s = hex.replace('#','');
    const bigint = parseInt(s.length===3 ? s.split('').map(c=>c+c).join('') : s, 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return [r/255, g/255, b/255, 1.0];
  }

  function getTargetMaterials(){
    const names = (mv.dataset.target||'').split(',').map(s=>s.trim()).filter(Boolean);
    const mats = mv.model?.materials || [];
    if(names.length===0) return mats; // apply to all
    return mats.filter(m => names.includes(m.name));
  }

  async function applyColor(hex){
    if(!mv.model) return;
    const mats = getTargetMaterials();
    mats.forEach(mat => {
      try {
        // Clear any baseColorTexture first
        mat.pbrMetallicRoughness?.baseColorTexture?.setTexture(null);
        // Set color factor
        const rgba = hexToRgba(hex);
        if (mat.setBaseColorFactor) mat.setBaseColorFactor(rgba);
        else if (mat.pbrMetallicRoughness) mat.pbrMetallicRoughness.baseColorFactor = rgba;
      } catch(e){ console.warn('applyColor err', e); }
    });
    applyInfo.textContent = 'Renk uygulandı';
    setTimeout(()=> applyInfo.textContent='', 1200);
  }

  async function applyTexture(url){
    if(!mv.model) return;
    const tex = await mv.createTexture(url);
    const mats = getTargetMaterials();
    mats.forEach(mat => {
      try {
        mat.pbrMetallicRoughness?.baseColorTexture?.setTexture(tex);
      } catch(e){ console.warn('applyTexture err', e); }
    });
    applyInfo.textContent = 'Doku uygulandı';
    setTimeout(()=> applyInfo.textContent='', 1200);
  }

  function renderPalette(items){
    swatches.innerHTML = '';
    items.forEach(it => {
      const el = document.createElement('span');
      el.className = 'swatch';
      if(it['#']) el.style.background = it['#'];
      if(it.texture) el.style.backgroundImage = 'url('+it.texture+')';
      el.title = it.name || '';
      el.addEventListener('click', ()=> it.texture ? applyTexture(it.texture) : applyColor(it['#']));
      swatches.appendChild(el);
    });
  }

  renderPalette(palette);

  // Load first model by default
  loadModel(catalog[0]);

})();</script>
</body>
</html>
