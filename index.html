<!doctype html>
<html lang="tr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PanelModels — Galeri Görüntüleyici</title>
  <link rel="icon" href="favicon.ico?v=5" sizes="any">

  <!-- Model Viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- Yeni minimal tasarım -->
  <link rel="stylesheet" href="css/viewer-makeup.css">

  <style>
    :root {
      /* İstersen markana göre güncelle */
      --accent: #68c3ff;
      --hover-accent: #698C8C;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif
    }
  </style>
</head>

<body>
  <div id="app" class="pm-app">
    <!-- Üst bar -->
    <header class="pm-top">
      <button id="menuBtn" class="btn only-mobile" aria-label="Menüyü aç/kapat">☰</button>
      <h1>PanelModels</h1>
      <small class="hint">Galeri • Malzeme paleti • Sahne & Kamera</small>
      <div class="spacer"></div>
      <button id="fsBtn" class="btn only-mobile" aria-label="Tam ekran">⤢</button>
    </header>

    <!-- Sol model kataloğu -->
    <aside id="sidebar" class="pm-left">
      <div class="pm-section-title">Modeller</div>
      <div class="pm-card-grid">
        <div class="pm-card is-active" data-model="vega">
          <img class="pm-thumb" src="thumbs/vega.png" alt="">
          <div>
            <div class="pm-card-title">Vega Panel</div>
            <div class="pm-card-sub">Ahşap profil</div>
          </div>
          <span class="pm-chip">GLB</span>
        </div>
        <!-- diğer modeller -->
      </div>
    </aside>

    <!-- Viewer ana sahne -->
    <main id="stage" class="pm-main">

      <div id="viewerHost" class="pm-canvas">
        <model-viewer id="mv" src="" camera-controls touch-action="pan-y" exposure="1.0" shadow-intensity="0.6"
          environment-image="neutral" interaction-prompt="none" poster-color="transparent"
          style="width:100%;height:100%;display:block"></model-viewer>
      </div>

      <div class="pm-overlay">
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn" id="btnShare">Paylaş</button>
      </div>

      <!-- Sağ panel kamera butonları -->
      <nav id="cameras" class="pm-right">
        <div class="pm-tool" data-cam="front"><span>Ön</span></div>
        <div class="pm-tool" data-cam="iso"><span>İzo</span></div>
        <div class="pm-tool" data-cam="zoom"><span>Zoom</span></div>
      </nav>

      <!-- Alt renk paleti -->
      <footer id="palette" class="pm-palette">
        <div class="pm-swatch is-active" data-mat="120-teak"></div>
        <div class="pm-swatch" data-mat="108-gold"></div>
        <!-- diğer renkler -->
      </footer>
    </main>
  </div>

  <!-- UI Enhancer -->
  <script src="js/ui-enhance.js"></script>

  <script>
    // Event hook örnekleri (kendi fonksiyonlarınla değiştir)
    window.addEventListener('pm:loadModel', e => loadModelById(e.detail.id));
    window.addEventListener('pm:applyMaterial', e => applyMaterial(e.detail.id));
    window.addEventListener('pm:setCamera', e => setCameraPreset(e.detail.preset));
    window.addEventListener('pm:reset', () => resetViewer());
    window.addEventListener('pm:share', () => shareCurrentView());
  </script>
  <script>
    const mv = document.getElementById('mv');
    let catalog = [];
    let palette = [];
    let currentModel = null;

    // --- JSON yükle ---
    async function loadData() {
      catalog = await fetch('catalog.json').then(r => r.json());
      palette = await fetch('palette.json').then(r => r.json());
    }

    // --- Model yükleme ---
    async function loadModelById(id) {
      if (!mv) return;
      if (!catalog.length) await loadData();
      const item = catalog.find(c => c.src.includes(`${id}.glb`) || c.src.includes(id));
      if (!item) return console.warn("Model bulunamadı:", id);

      currentModel = item;
      mv.src = item.src;
      await mv.updateComplete;

      if (item.defaults?.cameraPreset) setCameraPreset(item.defaults.cameraPreset);
      if (item.defaults?.rotationY != null) mv.turntableRotation = item.defaults.rotationY;
    }


    // --- Materyal uygula ---
    async function applyMaterial(matId) {
      if (!mv) return;
      if (!palette.length) await loadData();
      const sw = palette.find(p => p.id === matId);
      if (!sw) return console.warn("Palette yok:", matId);

      await mv.updateComplete;
      const model = mv.model;
      if (!model) return;

      const targets = currentModel?.targetMaterials || ['mdf-panel'];
      const mats = model.materials.filter(m =>
        targets.includes(m.name.toLowerCase()) ||
        targets.some(t => m.name.toLowerCase().includes(t))
      );
      if (!mats.length) return console.warn("Materyal yok:", model.materials.map(m => m.name));

      let tex = null;
      if (sw.texture && model.createTexture) {
        try { tex = await model.createTexture(sw.texture); }
        catch (e) { console.warn("Texture yüklenemedi:", e); }
      }

      for (const mat of mats) {
        const pbr = mat.pbrMetallicRoughness;
        if (!pbr) continue;
        if (tex) {
          if (pbr.setBaseColorTexture) pbr.setBaseColorTexture(tex);
          else if (pbr.baseColorTexture?.setTexture) pbr.baseColorTexture.setTexture(tex);
          if (pbr.setBaseColorFactor) pbr.setBaseColorFactor([1, 1, 1, 1]);
        } else if (sw.color && pbr.setBaseColorFactor) {
          const hex = sw.color.replace('#', '');
          const r = parseInt(hex.slice(0, 2), 16) / 255;
          const g = parseInt(hex.slice(2, 4), 16) / 255;
          const b = parseInt(hex.slice(4, 6), 16) / 255;
          pbr.setBaseColorFactor([r, g, b, 1]);
        }
      }
    }


    // --- Kamera preset ---

    function setCameraPreset(preset) {
      if (!mv) return;
      const map = {
        front: '0deg 90deg auto',
        back: '180deg 90deg auto',
        left: '-90deg 90deg auto',
        right: '90deg 90deg auto',
        iso45: '30deg 80deg auto',
        zoom: '0deg 75deg 2m'
      };
      if (map[preset]) mv.cameraOrbit = map[preset];
    }

    // --- Reset ---
    function resetViewer() {
      if (!mv) { console.warn('model-viewer bulunamadı'); return; }
      if (currentModel?.defaults?.cameraPreset) {
        setCameraPreset(currentModel.defaults.cameraPreset);
      } else {
        mv.cameraOrbit = '0deg 75deg auto';
      }
      mv.fieldOfView = '45deg';
    }

    // --- Share ---
    function shareCurrentView() {
      const url = new URL(location.href);
      if (currentModel) url.searchParams.set('model', currentModel.src);
      alert("Paylaşım linki:\n" + url.toString());
    }
  </script>

</body>

</html>