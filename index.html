<!doctype html>
<html lang="tr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PanelModels — Galeri Görüntüleyici</title>
  <link rel="icon" href="favicon.ico?v=5" sizes="any">

  <!-- Model Viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- Yeni minimal tema -->
  <link rel="stylesheet" href="css/viewer-makeup.css">

  <style>
    :root {
      --accent: #68c3ff;
      --hover-accent: #698C8C;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
  </style>
</head>

<body>
  <div id="app" class="pm-app">
    <!-- ÜST BAR -->
    <header class="pm-top">
      <button id="menuBtn" class="btn only-mobile" aria-label="Menüyü aç/kapat">☰</button>
      <h1>PanelModels</h1>
      <small class="hint">Galeri • Malzeme paleti • Sahne & Kamera</small>
      <div class="spacer"></div>
      <button id="fsBtn" class="btn only-mobile" aria-label="Tam ekran">⤢</button>
    </header>

    <!-- SOL KATALOG -->
    <aside id="sidebar" class="pm-left">
      <div class="pm-section-title">Modeller</div>
      <div class="pm-card-grid" id="cardGrid"></div> <!-- boş -->
    </aside>

    <!-- ORTA GÖRÜNTÜLEYİCİ -->
    <main id="stage" class="pm-main">
      <div id="viewerHost" class="pm-canvas">
        <model-viewer id="mv" src="" camera-controls touch-action="pan-y" exposure="1.0" shadow-intensity="0.6"
          environment-image="neutral" interaction-prompt="none" poster-color="transparent"
          style="width:100%;height:100%;display:block"></model-viewer>
      </div>

      <div class="pm-overlay">
        <button class="btn" id="btnReset">Reset</button>
        <button class="btn" id="btnShare">Paylaş</button>
      </div>
    </main>

    <!-- SAĞ KAMERA DOCK (main dışına alındı) -->
    <nav id="cameras" class="pm-right">
      <div class="pm-tool" data-cam="front"><span>Ön</span></div>
      <div class="pm-tool" data-cam="iso"><span>İzo</span></div>
      <div class="pm-tool" data-cam="zoom"><span>Zoom</span></div>
    </nav>

    <!-- ALT RENK PALETİ (main dışına alındı) -->
    <footer id="palette" class="pm-palette" id="paletteBar">
      <div id="swatchRow"></div> <!-- boş -->
    </footer>
  </div>

  <!-- UI Enhancer -->

  <!-- Event hook & gerçek davranışlar -->

  <script src="js/ui-enhance.js"></script>
  <script>
    const mv = document.getElementById('mv');
    const cardGrid = document.getElementById('cardGrid') || document.querySelector('.pm-card-grid');
    const swatchRow = document.getElementById('swatchRow') || document.querySelector('.pm-palette');

    let catalog = [];
    let palette = [];
    let currentModel = null;

    // JSON'ları yükle
    async function loadData() {
      const bust = `?v=${Date.now()}`;
      [catalog, palette] = await Promise.all([
        fetch('catalog.json' + bust).then(r => r.json()),
        fetch('palette.json' + bust).then(r => r.json()).catch(() => [])
      ]);
    }

    // Sol kartları çiz
    function renderCards() {
      if (!cardGrid) return;
      cardGrid.innerHTML = '';
      catalog.forEach((it) => {
        const id = (it.src.split('/').pop() || '').replace('.glb', ''); // vega
        const el = document.createElement('div');
        el.className = 'pm-card';
        el.dataset.model = id;
        el.innerHTML = `
        <img class="pm-thumb" src="${it.thumb || 'thumbs/default.png'}" alt="">
        <div>
          <div class="pm-card-title">${it.name || id}</div>
          <div class="pm-card-sub">GLB</div>
        </div>
        <span class="pm-chip">GLB</span>
      `;
        cardGrid.appendChild(el);
      });
    }

    // Alt paleti çiz
    function renderSwatches() {
      if (!swatchRow) return;
      // Eğer swatchRow zaten .pm-palette ise, içine swatch'ları atacağız
      const host = swatchRow.classList.contains('pm-palette') ? swatchRow : swatchRow.parentElement;
      const container = swatchRow.classList.contains('pm-palette') ? swatchRow : host;
      // Listeyi temizle (yalnızca .pm-swatch'ları)
      container.querySelectorAll('.pm-swatch').forEach(n => n.remove());

      palette.forEach(sw => {
        const dot = document.createElement('div');
        dot.className = 'pm-swatch';
        dot.dataset.mat = sw.id;
        if (sw.texture) {
          dot.style.backgroundImage = `url(${sw.texture})`;
          dot.style.backgroundSize = 'cover';
          dot.style.backgroundPosition = 'center';
        } else if (sw.color) {
          dot.style.background = sw.color;
        }
        container.appendChild(dot);
      });
    }

    // --- Davranışlar (viewer tarafı) ---
    async function loadModelById(id) {
      if (!mv) return;
      const item = catalog.find(c => c.src.includes(`${id}.glb`) || c.src.includes(id));
      if (!item) { console.warn('Model bulunamadı:', id); return; }

      currentModel = item;
      mv.src = item.src;
      await mv.updateComplete;

      if (item.defaults?.cameraPreset) setCameraPreset(item.defaults.cameraPreset);
      if (item.defaults?.rotationY != null) mv.turntableRotation = item.defaults.rotationY;

      // Sol listede aktif kartı işaretle
      document.querySelectorAll('.pm-card.is-active').forEach(c => c.classList.remove('is-active'));
      const active = document.querySelector(`.pm-card[data-model="${id}"]`);
      active?.classList.add('is-active');
    }

    async function applyMaterial(matId) {
      if (!mv) return;
      const sw = palette.find(p => p.id === matId);
      if (!sw) { console.warn('Palette yok:', matId); return; }

      await mv.updateComplete;
      const model = mv.model;
      if (!model) return;

      const targets = currentModel?.targetMaterials || ['mdf-panel'];
      const mats = model.materials.filter(m =>
        targets.includes(m.name.toLowerCase()) ||
        targets.some(t => m.name.toLowerCase().includes(t))
      );
      if (!mats.length) { console.warn('Materyal yok:', model.materials.map(m => m.name)); return; }

      let tex = null;
      if (sw.texture && model.createTexture) {
        try { tex = await model.createTexture(sw.texture); } catch (e) { console.warn('Texture yüklenemedi:', e); }
      }

      for (const mat of mats) {
        const pbr = mat.pbrMetallicRoughness;
        if (!pbr) continue;
        if (tex) {
          if (pbr.setBaseColorTexture) pbr.setBaseColorTexture(tex);
          else if (pbr.baseColorTexture?.setTexture) pbr.baseColorTexture.setTexture(tex);
          if (pbr.setBaseColorFactor) pbr.setBaseColorFactor([1, 1, 1, 1]);
        } else if (sw.color && pbr.setBaseColorFactor) {
          const hex = sw.color.replace('#', '');
          const r = parseInt(hex.slice(0, 2), 16) / 255;
          const g = parseInt(hex.slice(2, 4), 16) / 255;
          const b = parseInt(hex.slice(4, 6), 16) / 255;
          pbr.setBaseColorFactor([r, g, b, 1]);
        }
      }
    }

    function setCameraPreset(preset) {
      if (!mv) return;
      const map = {
        front: '0deg 90deg auto',
        back: '180deg 90deg auto',
        left: '-90deg 90deg auto',
        right: '90deg 90deg auto',
        iso45: '30deg 80deg auto',
        zoom: '0deg 75deg 2m'
      };
      if (map[preset]) mv.cameraOrbit = map[preset];
    }

    function resetViewer() {
      if (!mv) return;
      if (currentModel?.defaults?.cameraPreset) setCameraPreset(currentModel.defaults.cameraPreset);
      else mv.cameraOrbit = '0deg 75deg auto';
      mv.fieldOfView = '45deg';
    }

    function shareCurrentView() {
      const url = new URL(location.href);
      if (currentModel) url.searchParams.set('model', currentModel.src);
      navigator.clipboard?.writeText(url.toString());
      alert('Link kopyalandı:\n' + url.toString());
    }

    // ui-enhance.js eventlerini dinle
    window.addEventListener('pm:loadModel', e => loadModelById(e.detail.id));
    window.addEventListener('pm:applyMaterial', e => applyMaterial(e.detail.id));
    window.addEventListener('pm:setCamera', e => setCameraPreset(e.detail.preset));
    window.addEventListener('pm:reset', () => resetViewer());
    window.addEventListener('pm:share', () => shareCurrentView());

    // BOOT
    (async function boot() {
      await loadData();
      renderCards();
      renderSwatches();

      // Başlangıç modeli: querystring ?model=... varsa onu, yoksa ilkini yükle
      const qs = new URLSearchParams(location.search);
      const direct = qs.get('model');
      if (direct) {
        const id = (direct.split('/').pop() || '').replace('.glb', '');
        await loadModelById(id);
      } else if (catalog[0]) {
        const id = (catalog[0].src.split('/').pop() || '').replace('.glb', '');
        await loadModelById(id);
      }
    })();
  </script>
</body>

</html>