<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PanelModels — Galeri Görüntüleyici</title>
<link rel="icon" href="favicon.ico?v=3" sizes="any">
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<style>
:root{
  --bg:#0b0f14; --panel:#111821; --text:#eaf0f8; --muted:#a3aebb; --border:#1e2a39; --accent:#68c3ff;
  --hover-accent:#698C8C;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

/* Layout */
.app{display:grid;grid-template-columns:320px 1fr;grid-template-rows:auto 1fr;gap:12px;height:100%}
header{grid-column:1/-1;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
header h1{margin:0;font-size:18px}
header small{color:var(--muted)}
.btn{background:#0e141c;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px;cursor:pointer;transition:color .15s ease, border-color .15s ease}
.btn:hover{border-color:#2c3e55}
.only-mobile{display:none}

aside.side{padding:12px;background:var(--panel);border-right:1px solid var(--border);overflow:auto}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.card{background:#0e141c;border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column}
.card:hover{outline:1px solid #29415a}
.card img{width:100%;aspect-ratio:4/3;object-fit:cover;background:#000}
.card .meta{padding:6px 8px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px}

.viewer{position:relative;background:#000;border-radius:12px;overflow:hidden;margin:0 12px 12px 0}
model-viewer{width:100%;height:100%;min-height:560px;--poster-color:transparent}

/* Right panel */
.controls{position:absolute; top:12px; right:12px; z-index:5; display:flex; flex-direction:column; gap:10px; width: min(320px, 32vw)}
.card2{background:rgba(10,14,20,.50); backdrop-filter:blur(4px); border:1px solid var(--border); border-radius:12px; padding:10px;}
.card2 h3{margin:0 0 8px 0; font-size:12px; color:var(--muted); letter-spacing:.3px; text-transform:uppercase}
.row{display:flex; align-items:center; gap:8px}
.row label{font-size:12px; color:var(--muted); width:92px}
input[type="range"]{width:100%; accent-color:var(--accent)}

/* Collapsible "Sahne" (mobilde) */
details.card2.scene{padding:0}
details.card2.scene > summary{list-style:none; cursor:pointer; padding:10px; display:flex; align-items:center}
details.card2.scene > summary::-webkit-details-marker{display:none}
details.card2.scene > summary h3{margin:0; font-size:12px; color:var(--muted); letter-spacing:.3px; text-transform:uppercase}
details.card2.scene > summary::after{content:'▾'; margin-left:auto; opacity:.6; transition:transform .2s ease}
details.card2.scene[open] > summary::after{transform:rotate(180deg)}
details.card2.scene .body{padding:0 10px 10px}

/* Kamera kartı: 1/3 genişlik + kare butonlar */
.card2.cam{width:33%; align-self:flex-end}
.iconbar{display:flex; flex-direction:column; gap:8px}
.iconbtn{
  width:100%;
  aspect-ratio:1/1;                 /* kare */
  display:grid; place-items:center;
  border:1px solid var(--border);
  background:#0e141c;
  border-radius:10px;
  cursor:pointer;
  color:#fff;                       /* ikon rengi */
  transition:border-color .15s ease, color .12s ease, background .15s ease
}
.iconbtn:hover{border-color:#2c3e55; color:var(--hover-accent)} /* hover rengi #698C8C */
.iconbtn svg{width:26px; height:26px;}

/* Alt palet barı */
.pbar{
  position:absolute; left:12px; right:12px; bottom:12px; z-index:6;
  background:transparent;          /* tamamen şeffaf */
  border:none;                      /* çerçeve yok */
  padding:6px 10px 10px 10px;      /* daha kompakt */
  overflow:visible;
}
.pbar .title{display:none}          /* başlık gizlendi */
.swrow{display:flex; gap:12px; overflow-x:auto; padding-bottom:4px; scrollbar-width:thin}
.swrow::-webkit-scrollbar{height:8px}
.swrow::-webkit-scrollbar-thumb{background:#253548;border-radius:8px}

/* Swatch — 1.5x büyütme, hover’da 3x */
.swmini{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:60px;position:relative;overflow:visible}
.swatch{
  width:51px;height:51px;           /* 34 -> 51 px (1.5x) */
  border-radius:10px;border:1px solid var(--border);
  cursor:pointer;background-size:cover;background-position:center;
  transition:transform .18s cubic-bezier(.2,.6,.2,1), box-shadow .18s ease, outline-color .18s;
  will-change:transform;
}
.swmini:hover .swatch,
.swatch:focus-visible{transform:scale(3); z-index:5; box-shadow:0 16px 30px rgba(0,0,0,.40); outline:1px solid var(--accent)}
.slabel{font-size:10px;color:var(--muted);max-width:60px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Reset butonu – hover & active rengi */
#bgReset:hover{ color:var(--hover-accent) }
#bgReset:active{ color:var(--hover-accent) }

/* Mobile */
@media (max-width: 900px){
  .only-mobile{display:inline-flex}
  .app{grid-template-columns:1fr; grid-template-rows:auto 1fr}
  aside.side{position:fixed; z-index:50; top:0; left:0; bottom:0; width:min(84vw, 360px); transform:translateX(-105%); transition:transform .28s ease; border-right:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,.4)}
  aside.side.open{ transform:translateX(0) }
  model-viewer{ min-height:65vh }
  .controls{ position:static; width:auto; margin:12px; }
  .pbar{ left:8px; right:8px; bottom:8px }
}
@media (max-width: 420px){ model-viewer{ min-height:70vh } }
@supports(padding:max(0px)){
  header{ padding-left:max(12px, env(safe-area-inset-left)); padding-right:max(12px, env(safe-area-inset-right)) }
}
.hint{color:var(--muted);font-size:12px}
.spacer{flex:1 1 auto}
.overlay{position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(2px); z-index:40}
</style>
</head>
<body>
  <div class="app">
    <header>
      <button id="menuBtn" class="btn only-mobile" aria-label="Menüyü aç/kapat">☰</button>
      <h1>PanelModels</h1>
      <small class="hint">Galeri • Malzeme paleti • Sahne & Kamera</small>
      <div class="spacer"></div>
      <button id="fsBtn" class="btn only-mobile" aria-label="Tam ekran">⤢</button>
    </header>

    <aside id="side" class="side">
      <div id="gallery" class="grid"></div>
    </aside>
    <div id="overlay" class="overlay" hidden></div>

    <main class="viewer" id="viewerHost">
      <model-viewer id="mv"
        camera-controls
        shadow-intensity="0.7"
        exposure="1.0"
        environment-rotation="0deg"
        touch-action="pan-y"
        reveal="auto"
        alt="3B model görüntüleyici">
        <div class="hint" slot="poster">Model yükleniyor…</div>
        <div class="hint" slot="progress-bar">Yükleniyor…</div>
        <button class="btn" slot="ar-button">AR ile Gör</button>
      </model-viewer>

      <!-- Sağ panel -->
      <div class="controls">
        <!-- Sahne -->
        <details id="sceneCard" class="card2 scene" open>
          <summary><h3>Sahne</h3></summary>
          <div class="body">
            <div class="row"><label>Parlaklık</label><input id="exp" type="range" min="0.3" max="1.8" step="0.05" value="1.0"></div>
            <div class="row" style="margin-top:6px"><label>Gölge</label><input id="shadow" type="range" min="0" max="1" step="0.02" value="0.7"></div>
            <div class="row" style="margin-top:6px"><label>Güneş Açısı</label><input id="envrot" type="range" min="0" max="360" step="1" value="0"></div>
            <div class="row" style="margin-top:8px"><label>Arkaplan</label>
              <div style="display:flex;align-items:center;gap:10px">
                <input id="bgHue" type="range" min="0" max="360" step="1" value="180" title="Ton">
                <input id="bgSat" type="range" min="0" max="35" step="1" value="25" title="Doygunluk">
                <input id="bgVal" type="range" min="25" max="75" step="1" value="55" title="Parlaklık">
                <div id="bgPrev" style="width:26px;height:26px;border-radius:6px;border:1px solid var(--border)"></div>
                <button id="bgReset" class="btn">Reset</button>
              </div>
            </div>
          </div>
        </details>

        <!-- Kamera (dikey, dar) -->
        <div class="card2 cam">
          <h3>Kamera</h3>
          <div class="iconbar">
            <button class="iconbtn" data-orbit="0deg 0deg auto" title="Üstten">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3.5" y="3.5" width="17" height="17" rx="2" stroke-width="1.8"/><rect x="7" y="7" width="10" height="4" rx="1" fill="currentColor"/></svg>
            </button>
            <button class="iconbtn" data-orbit="0deg 180deg auto" title="Alttan">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3.5" y="3.5" width="17" height="17" rx="2" stroke-width="1.8"/><rect x="7" y="13" width="10" height="4" rx="1" fill="currentColor"/></svg>
            </button>
            <button class="iconbtn" data-orbit="0deg 75deg auto" title="Önden">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4.5" y="4.5" width="15" height="15" rx="2" stroke-width="1.8"/><rect x="8" y="8" width="8" height="8" rx="1" fill="currentColor"/></svg>
            </button>
            <button class="iconbtn" data-orbit="180deg 75deg auto" title="Arkadan">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4.5" y="4.5" width="15" height="15" rx="2" stroke-width="1.8"/><path d="M8 8h8v8H8z" stroke-width="1.8"/></svg>
            </button>
            <button class="iconbtn" data-orbit="45deg 60deg auto" title="Ön sağ 45° yukarı">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="4" y="6" width="14" height="12" rx="2" transform="skewX(-10)" stroke-width="1.6"/><line x1="12" y1="4" x2="18" y2="8" stroke-width="1.6"/></svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Alt tek sıra palet (tam şeffaf) -->
      <div class="pbar">
        <div class="title">Kaplama / Renk</div>
        <div id="swrow" class="swrow"></div>
      </div>
    </main>
  </div>

<script>
(async function(){
  const mv = document.getElementById('mv');
  const gallery = document.getElementById('gallery');
  const swrow = document.getElementById('swrow');
  const host = document.getElementById('viewerHost');

  async function loadJSON(paths){
    for(const p of paths){
      try{
        const r = await fetch(p, {cache:'no-store'});
        if(r.ok) return await r.json();
      }catch(e){}
    }
    return null;
  }

  let catalog = await loadJSON(['catalog.json','./catalog.json']) || [];
  if(!Array.isArray(catalog) || !catalog.length){
    const arr = await loadJSON(['files.json']);
    if(arr) catalog = arr.map(name => ({ name, src:name, thumb:'thumbs/default.png' }));
  }
  if(!Array.isArray(catalog) || !catalog.length){
    gallery.innerHTML = '<div class="hint">Katalog yok. <code>catalog.json</code> veya <code>files.json</code> ekleyin.</div>';
    return;
  }

  let palette = await loadJSON(['palette.json','materials/palette.json','./palette.json']);
  if(!Array.isArray(palette)){
    console.warn('palette.json bulunamadı, örnek palet kullanılıyor.');
    palette = [
      {"name":"Antrasit","#":"#2F343A"},
      {"name":"Teak Doku","texture":"materials/teak.png"},
      {"name":"Beyaz","#":"#ECEFF1"},
      {"name":"Siyah","#":"#121212"}
    ];
  }

  function renderGallery(items){
    gallery.innerHTML = '';
    items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';
      const img = new Image();
      img.loading = 'lazy';
      img.src = item.thumb || 'thumbs/default.png';
      img.alt = item.title||item.name||'';
      img.onerror = ()=>console.warn('Thumb 404:', item.thumb);
      card.appendChild(img);
      const meta = document.createElement('div');
      meta.className='meta';
      meta.innerHTML = `<span>${item.title||item.name||item.src}</span><span>${item.size||''}</span>`;
      card.appendChild(meta);
      card.addEventListener('click', ()=> loadModel(item));
      gallery.appendChild(card);
    });
  }
  renderGallery(catalog);

  function loadModel(item){
    mv.src = item.src;
    mv.alt = item.title || item.name || item.src;
    const targets = (item.targetMaterials && item.targetMaterials.length)
      ? item.targetMaterials
      : ['PanelKaplama'];
    mv.dataset.target = targets.join(',');
    document.title = 'PanelModels — ' + mv.alt;
  }

  function getTargetMaterials(){
    const wanted = (mv.dataset.target||'').split(',').map(s=>s.trim()).filter(Boolean);
    const all = mv.model?.materials || [];
    const kap = all.filter(m => m.name==='PanelKaplama' || m.name?.startsWith('PanelKaplama.'));
    if (kap.length) return kap;
    if (wanted.length){
      const picked = all.filter(m => wanted.some(n => m.name===n || m.name?.startsWith(n+'.')));
      if (picked.length) return picked;
    }
    console.warn('Hedef malzeme bulunamadı, tüm malzemeler boyanacak:', all.map(m=>m.name));
    return all;
  }

  function hexToRgba(hex){
    const s = hex.replace('#','');
    const h = s.length===3 ? s.split('').map(c=>c+c).join('') : s;
    const v = parseInt(h, 16);
    return [(v>>16&255)/255, (v>>8&255)/255, (v&255)/255, 1];
  }

  async function applyColor(hex){
    if(!mv.model) return;
    const mats = getTargetMaterials();
    const rgba = hexToRgba(hex);
    for (const mat of mats) {
      try {
        const pmr = mat.pbrMetallicRoughness;
        if (mat.setBaseColorTexture) mat.setBaseColorTexture(null);
        else if (pmr?.baseColorTexture) pmr.baseColorTexture.setTexture(null);
        if (pmr?.setBaseColorFactor) pmr.setBaseColorFactor(rgba);
        else pmr.baseColorFactor = rgba;
      } catch (e) { console.warn('applyColor:', e); }
    }
  }

  const texCache = new Map();
  async function applyTexture(url){
    if(!mv.model) return;
    try{
      let tex = texCache.get(url);
      if(!tex){
        tex = await mv.createTexture(url);
        texCache.set(url, tex);
      }
      const mats = getTargetMaterials();
      for (const mat of mats) {
        const pmr = mat.pbrMetallicRoughness;
        if (pmr?.setBaseColorFactor) pmr.setBaseColorFactor([1,1,1,1]);
        else pmr.baseColorFactor = [1,1,1,1];
        if (mat.setBaseColorTexture) { mat.setBaseColorTexture(tex); }
        else if (pmr?.setBaseColorTexture) { pmr.setBaseColorTexture(tex); }
        else if (pmr?.baseColorTexture) { pmr.baseColorTexture.setTexture(tex); }
      }
    }catch(e){
      console.warn('Texture yüklenemedi:', url, e);
    }
  }

  function renderPaletteRow(items){
    swrow.innerHTML = '';
    items.forEach(it => {
      const wrap = document.createElement('div');
      wrap.className = 'swmini';
      const el = document.createElement('span');
      el.className = 'swatch';
      el.title = it.name || '';
      if(it['#']) el.style.background = it['#'];
      if(it.texture){
        el.style.backgroundImage = 'url('+it.texture+')';
        const testImg = new Image();
        testImg.src = it.texture;
        testImg.onerror = ()=>console.warn('Texture 404:', it.texture);
      }
      el.addEventListener('click', ()=> it.texture ? applyTexture(it.texture) : applyColor(it['#']));
      const lbl = document.createElement('div');
      lbl.className = 'slabel';
      lbl.textContent = it.name || '';
      wrap.appendChild(el); wrap.appendChild(lbl);
      swrow.appendChild(wrap);
    });
  }
  renderPaletteRow(palette);

  mv.addEventListener('load', ()=> {
    console.log('Materials:', (mv.model?.materials||[]).map(m=>m.name));
  });

  /* Sahne ayarları */
  const exp = document.getElementById('exp');
  const sh = document.getElementById('shadow');
  const rot = document.getElementById('envrot');
  const applyScene = () => { mv.exposure = Number(exp.value); mv.shadowIntensity = Number(sh.value); mv.environmentRotation = rot.value + 'deg'; };
  [exp, sh, rot].forEach(i => i.addEventListener('input', applyScene));
  applyScene();

  /* Pastel arkaplan (HSV) */
  const bgHue = document.getElementById('bgHue');
  const bgSat = document.getElementById('bgSat');
  const bgVal = document.getElementById('bgVal');
  const bgPrev = document.getElementById('bgPrev');
  const bgReset = document.getElementById('bgReset');

  function hsvToRgb(h,s,v){
    s/=100; v/=100;
    const c=v*s, x=c*(1-Math.abs(((h/60)%2)-1)), m=v-c;
    let r=0,g=0,b=0;
    if (0<=h&&h<60){r=c;g=x;b=0;} else if (60<=h&&h<120){r=x;g=c;b=0;}
    else if (120<=h&&h<180){r=0;g=c;b=x;} else if (180<=h&&h<240){r=0;g=x;b=c;}
    else if (240<=h&&h<300){r=x;g=0;b=c;} else {r=0;g=0;b=c;}
    return [Math.round((r+m)*255),Math.round((g+m)*255),Math.round((b+m)*255)];
  }
  function applyBg(){
    const [r,g,b]=hsvToRgb(Number(bgHue.value), Number(bgSat.value), Number(bgVal.value));
    const css=`rgb(${r}, ${g}, ${b})`;
    host.style.background=css; bgPrev.style.background=css;
  }
  [bgHue,bgSat,bgVal].forEach(i=>i.addEventListener('input',applyBg));
  bgReset.addEventListener('click', ()=>{
    host.style.background='linear-gradient(180deg,#0b0f14,#0a0d12)';
    bgPrev.style.background=host.style.background;
  });
  applyBg();

  /* Mobil menü */
  const side = document.getElementById('side');
  const overlay = document.getElementById('overlay');
  document.getElementById('menuBtn')?.addEventListener('click', () => {
    const isOpen = side.classList.toggle('open');
    overlay.hidden = !isOpen;
    document.documentElement.style.overflow = isOpen ? 'hidden' : '';
  });
  overlay?.addEventListener('click', () => {
    side.classList.remove('open'); overlay.hidden = true;
    document.documentElement.style.overflow = '';
  });
  document.getElementById('fsBtn')?.addEventListener('click', async () => {
    try {
      if (document.fullscreenElement) await document.exitFullscreen();
      else await (mv.requestFullscreen?.() || document.documentElement.requestFullscreen());
    } catch(e){ console.warn('fullscreen error', e); }
  });

  /* Kamera presetleri */
  document.querySelectorAll('.iconbtn[data-orbit]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const orbit = btn.getAttribute('data-orbit');
      mv.setAttribute('camera-orbit', orbit);
      mv.setAttribute('camera-target', 'auto');
    });
  });

  /* Sahne kartı: mobilde kapalı, desktopta açık kalsın */
  const sceneCard = document.getElementById('sceneCard');
  const setSceneOpenByViewport = () => {
    if (window.innerWidth <= 900) sceneCard.removeAttribute('open');
    else sceneCard.setAttribute('open','');
  };
  setSceneOpenByViewport();
  window.addEventListener('resize', setSceneOpenByViewport);

  /* Başlangıç modeli */
  loadModel(catalog[0]);
})();
</script>
</body>
</html>
